---
title: 'DR-SC: DLPFC Data Analysis'
author: "Wei Liu"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DR-SC DLPFC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The package can be loaded with the command:
```{r  eval = FALSE}
library("DR.SC")
```


## Fit DR-SC using real data HCC1
### load the data HCC1 in package DR.SC
```{r  eval = FALSE,message=FALSE, warning=FALSE}
data("dlpfc151510", package = 'DR.SC')
```

### Data preprocessing
```{r  eval = FALSE}
library(Seurat)
# standard log-normalization
dlpfc151510 <- NormalizeData(dlpfc151510, verbose = F)
# choose 500 highly variable features
seu <- FindVariableFeatures(dlpfc151510, nfeatures = 500, verbose = F)
```

## Fit DR-SC model using 1000 highly variable features
We set the argument variable.type='HVGs' (default option) to use the highly variable genes.
```{r  eval = FALSE}
### Given K
seu <- DR.SC(seu, K=7, platform = 'Visium', verbose=F)
```

### Visualization
```{r  eval = FALSE}
spatialPlotClusters(seu)
```


Show the tSNE plot based on the extracted features from DR-SC.
```{r  eval = FALSE}
drscPlot(seu)
```

Show the UMAP plot based on the extracted features from DR-SC.
```{r  eval = FALSE}
drscPlot(seu, visu.method = 'UMAP')
```

## Fit DR-SC model using 480 spatially variable features

```{r  eval = FALSE}
# choose 480 spatially variable features
seus <- FindSVGs(seu, nfeatures = 480)
```

We set the argument variable.type='SVGs' (default option) to use the spatially variable genes.
```{r  eval = FALSE}
### Given K
seus <- DR.SC(seus, K=7, platform = 'Visium', verbose=T)
```

### Visualization
Show the spatial scatter plot for clusters
```{r  eval = FALSE}
spatialPlotClusters(seus)
```


Show the tSNE plot based on the extracted features from DR-SC.
```{r  eval = FALSE}
drscPlot(seus)
```
Show the UMAP plot based on the extracted features from DR-SC.
```{r  eval = FALSE}
drscPlot(seus, visu.method = 'UMAP')
```


### Ridge plots 
Find the marker genes in SVGs for each clusters
```{r  eval = FALSE}
SVGs <- topSVGs(seus, ntop = 400)
dat <- FindAllMarkers(seus, features = SVGs)
head(dat)
library(dplyr, verbose=F)
top2 <-  dat %>%
  group_by(cluster) %>%
  top_n(n = 2, wt = avg_log2FC)
top2
```

Visualize single cell expression distributions in each cluster from Seruat.
```{r  eval = FALSE, fig.height=6, fig.width=10}
genes <- top2$gene[seq(1, 12, by=2)]
RidgePlot(seus, features = genes, ncol = 2)
```
### Violin plot

Visualize single cell expression distributions in each cluster
```{r  eval = FALSE, fig.height=8, fig.width=10}

VlnPlot(seus, features = genes, ncol=2)
```

### Feature plot
We extract tSNE based on the features from DR-SC and then visualize feature expression in the low-dimensional space
 
```{r  eval = FALSE, fig.height=8, fig.width=10}
seus <- RunTSNE(seus, reduction="dr-sc", reduction.key='drsc_tSNE_')
FeaturePlot(seus, features = genes, reduction = 'tsne' ,ncol=2)

```


### Dot plots 
The size of the dot corresponds to the percentage of cells expressing the
feature in each cluster. The color represents the average expression level
```{r  eval = FALSE}
DotPlot(seus, features = genes)
```

### Heatmap plot

Single cell heatmap of feature expression
```{r  eval = FALSE, fig.height=8, fig.width=10}
top20 <-  dat %>%
  group_by(cluster) %>%
  top_n(n = 20, wt = avg_log2FC)
genes <- top20$gene
# standard scaling (no regression)
seus <- ScaleData(seus)
DoHeatmap(subset(seus, downsample = 500), features = genes, size = 5)
```

## Fit DR-SC model using 480 spatially variable features and using MBICã€€to determine clusters

```{r  eval = FALSE}
# choose 2000 spatially variable features
seus <- FindSVGs(seu, nfeatures = 480, verbose = F)
```

We set the argument variable.type='SVGs' (default option) to use the spatially variable genes.
```{r  eval = FALSE}
### Given K
seus <- DR.SC(seus, K=3:9, platform = 'Visium', verbose=F)
```

Plot the MBIC curve 
```{r  eval = FALSE}
seus <- selectModel(seus, pen.const = 0.8)
mbicPlot(seus)
```

Show the spatial scatter plot for clusters
```{r  eval = FALSE}
spatialPlotClusters(seus)
```

Show the tSNE plot based on the extracted features from DR-SC.
```{r  eval = FALSE}
drscPlot(seus, dims=1:10)
```


## Session information
```{r  eval = FALSE}
sessionInfo()
```